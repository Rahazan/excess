var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;function trace(d){"\n"===d[d.length-1]&&(d=d.substring(0,d.length-1));if(window.performance){var e=(window.performance.now()/1E3).toFixed(3);console.log(e+": "+d)}else console.log(d)}
if(navigator.mozGetUserMedia)console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=function(d,e){if(d&&d.iceServers)for(var b=0;b<d.iceServers.length;b++)d.iceServers[b].hasOwnProperty("urls")&&(d.iceServers[b].url=d.iceServers[b].urls,delete d.iceServers[b].urls);return new mozRTCPeerConnection(d,e)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=
mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,MediaStreamTrack.getSources=function(d){setTimeout(function(){d([{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}])},0)},window.createIceServer=function(d,e,b){var a=null,h=d.split(":");if(0===h[0].indexOf("stun"))a={url:d};else if(0===h[0].indexOf("turn"))if(27>webrtcDetectedVersion){if(d=d.split("?"),1===d.length||0===d[1].indexOf("transport=udp"))a=
{url:d[0],credential:b,username:e}}else a={url:d,credential:b,username:e};return a},window.createIceServers=function(d,e,b){for(var a=[],h=0;h<d.length;h++){var k=window.createIceServer(d[h],e,b);null!==k&&a.push(k)}return a},attachMediaStream=function(d,e){console.log("Attaching media stream");d.mozSrcObject=e},reattachMediaStream=function(d,e){console.log("Reattaching media stream");d.mozSrcObject=e.mozSrcObject};else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome");var webrtcDetectedBrowser=
"chrome",result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./),webrtcDetectedVersion=null!==result?parseInt(result[2],10):999;window.createIceServer=function(d,e,b){var a=null,h=d.split(":");0===h[0].indexOf("stun")?a={url:d}:0===h[0].indexOf("turn")&&(a={url:d,credential:b,username:e});return a};window.createIceServers=function(d,e,b){return{urls:d,credential:b,username:e}};RTCPeerConnection=function(d,e){return new webkitRTCPeerConnection(d,e)};getUserMedia=navigator.webkitGetUserMedia.bind(navigator);
navigator.getUserMedia=getUserMedia;attachMediaStream=function(d,e){"undefined"!==typeof d.srcObject?d.srcObject=e:"undefined"!==typeof d.mozSrcObject?d.mozSrcObject=e:"undefined"!==typeof d.src?d.src=URL.createObjectURL(e):console.log("Error attaching stream to element.")};reattachMediaStream=function(d,e){d.src=e.src}}else console.log("Browser does not appear to be WebRTC-capable");
function requestUserMedia(d){return new Promise(function(e,b){var a=function(a){e(a)},h=function(a){b(a)};try{getUserMedia(d,a,h)}catch(k){b(k)}})};var events;
(function(d){var e=function(){function b(){this._listeners=[]}b.prototype.add=function(a){this._listeners.push(a)};b.prototype.remove=function(a){if("function"===typeof a)for(var h=this._listeners.length;0<h;h++){if(this._listeners[0]===a){this._listeners.splice(0,1);break}}else this._listeners=[]};b.prototype.trigger=function(){for(var a=[],h=0;h<arguments.length;h++)a[h-0]=arguments[h];for(var h={},b=this._listeners.slice(0),d=0,g=b.length;d<g;d++)b[d].apply(h,a||[])};return b}();d.TypedEvent=e})(events||
(events={}));var excess;(function(d){d.log=function(){for(var d=[],b=0;b<arguments.length;b++)d[b-0]=arguments[b];return console.log.apply(console,d)};d.debug=function(){for(var d=[],b=0;b<arguments.length;b++)d[b-0]=arguments[b];return console.debug.apply(console,d)};d.err=function(){for(var d=[],b=0;b<arguments.length;b++)d[b-0]=arguments[b];return console.error.apply(console,d)}})(excess||(excess={}));var c;window.onload=function(){};
(function(d){var e=function(){function b(a){var h=this;this.onMessage=new events.TypedEvent;this.onClose=new events.TypedEvent;this.onError=new events.TypedEvent;this.onOpen=new events.TypedEvent;this._onMessage=function(a){h.onMessage.trigger(a.data)};this._onError=function(a){d.log("\nCHANNEL ERROR: ",a);h.onError.trigger(a)};this._onClose=function(a){d.log("\nCHANNEL CLOSE: ",a);h.onClose.trigger(a)};this._onOpen=function(a){d.log("\nCHANNEL OPEN: ",a);h.onOpen.trigger(a)};this.dataChannel=a;this.attachCallbacks()}
Object.defineProperty(b.prototype,"label",{get:function(){return this.dataChannel.label},enumerable:!0,configurable:!0});b.prototype.attachCallbacks=function(){this.dataChannel.onmessage=this._onMessage;this.dataChannel.onerror=this._onError;this.dataChannel.onclose=this._onClose;this.dataChannel.onopen=this._onOpen};b.prototype.send=function(a){this.dataChannel.send(a)};return b}();d.Channel=e})(excess||(excess={}));
(function(d){var e=function(){function b(a,h,b){var f=this;void 0===b&&(b=[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"}]);this.onConnection=new events.TypedEvent;this.receiveSignalMessage=function(a,b){var h=f.connections[a]?!0:!1;b?"offer"==b.type?(h&&console.warn("Already have a connection with fromId!"),d.log("Received OFFER from",a,b),h=f.createPeer(a),h.answer(b),f.onConnection.trigger(h)):"answer"==b.type?h?(d.log("Received ANSWER from ",a,b),f.connections[a].setRemoteDescription(b)):
console.error("Received answer SDP from unknown peer: ",a):b.candidate?h?(d.debug("Received ICE candidate from",a,b),f.connections[a].addIceCandidate(b)):console.error("Received ICE candidate from unknown peer: ",a):console.warn("Received unexpected signal message ",b," from ",a):console.error("Received empty signalling message, error from server?")};this.id=h;this.connections={};this.rtcConfig={iceServers:b};this.signaller=new d.Signaller(a,h);this.signaller.onSignal.add(this.receiveSignalMessage)}
b.prototype.connectToServer=function(){return this.signaller.connect()};b.prototype.connect=function(a){if(a==this.id)return console.error("You can't connect to yourself!"),null;a=this.createPeer(a);a.call();return a};b.prototype.createPeer=function(a){var b=this;d.log("Creating peer for ",a);var k=new d.ExcessPeer(a,this.signaller,this.rtcConfig);this.connections[a]=k;k.onClose.add(function(){d.log("Connection to ",a,"closed, deleting peer");delete b.connections[a]});return k};b.prototype.joinRoom=
function(a){this.currentRoom=a;this.signaller.join(a)};b.prototype.requestRoom=function(a,b){this.signaller.discover(a,b)};return b}();d.ExcessClient=e})(excess||(excess={}));
(function(d){var e=function(){function b(a,b,k){var f=this;this.onClose=new events.TypedEvent;this.onDataChannelReceive=new events.TypedEvent;this.remoteDescriptionSet=this.caller=!1;this.onSDPCreate=function(a){f.connection.setLocalDescription(a,f.onLocalDescrAdded,function(){return d.err("Failed to set local description!")});f.signaller.signal(f.id,a)};this.onSDPError=function(a){console.error(a)};this.onLocalDescrAdded=function(){d.log("Set local description ",f.caller?"(OFFER).":"(ANSWER).")};
this.onStateChange=function(a){d.log("Connection state change ",a)};this.onIceStateChange=function(a){d.log("ICE state changed: connection:",f.connection.iceConnectionState,"gathering:",f.connection.iceGatheringState)};this.onIceCandidate=function(a){a.candidate&&f.signaller.signal(f.id,{sdpMLineIndex:a.candidate.sdpMLineIndex,sdpMid:a.candidate.sdpMid,candidate:a.candidate.candidate})};this.signaller=b;this.id=a;this.iceBuffer=[];this.channels={};this.connection=new RTCPeerConnection(k);this.connection.ondatachannel=
function(a){f.addDataChannel(a.channel);f.onDataChannelReceive.trigger(f.channels[a.channel.label])};this.connection.onnegotiationneeded=function(a){return console.warn("Negotation needed!")};this.connection.onicecandidate=this.onIceCandidate;this.connection.onstatechange=this.onStateChange;this.connection.oniceconnectionstatechange=this.onIceStateChange}b.prototype.call=function(){this.createDataChannel("excess");this.caller=!0;this.connection.createOffer(this.onSDPCreate,this.onSDPError)};b.prototype.answer=
function(a){var b=this;this.caller&&(this.caller=!1);this.setRemoteDescription(a,function(){return b.connection.createAnswer(b.onSDPCreate,b.onSDPError)})};b.prototype.createDataChannel=function(a,b){void 0===b&&(b={});d.log("Creating data channel ",a," opts:",b);var k=this.connection.createDataChannel(a,b);return this.addDataChannel(k)};b.prototype.addDataChannel=function(a){var b=this;"object"!=typeof a&&console.error("Data channel is not even an object!");d.log("Added data channel ",a);var k=new d.Channel(a);
this.channels[a.label]=k;this.channels[a.label].onClose.add(function(){return delete b.channels[a.label]});return k};b.prototype.addIceCandidate=function(a){this.remoteDescriptionSet?(a=new RTCIceCandidate(a),this.connection.addIceCandidate(a)):(d.log("Buffering ICE candidate"),this.iceBuffer.push(a))};b.prototype.setRemoteDescription=function(a,b){var k=this;void 0===b&&(b=function(){});d.log("Attempting to set remote description.");var f=new RTCSessionDescription(a);this.connection.setRemoteDescription(f,
function(){d.log("Set remote description",k.caller?"(ANSWER).":"(OFFER).");k.remoteDescriptionSet=!0;k.addIceBuffer();b.apply(k)},function(a){return console.error("Failed to set remote descr",a)})};b.prototype.addIceBuffer=function(){for(;0<this.iceBuffer.length;){var a=this.iceBuffer.shift();this.addIceCandidate(a)}};return b}();d.ExcessPeer=e})(excess||(excess={}));
(function(d){var e=function(){function b(a,b){var d=this;this.onSignal=new events.TypedEvent;this.addChannel=function(a,b){d.signalChannel=b;d.currentRoom=b.topic;b.on("msg:user",function(a){d.onSignal.trigger(a.from,a.data)})};this.receiveDiscovery=function(a){d.discoveryCallbacks[a.r](a.users);delete d.discoveryCallbacks[a.r]};this.id=b;this.discoveryCallbacks={};this.endPoint=a}b.prototype.connect=function(){var a=this;this.socket=new Phoenix.Socket(this.endPoint);var b=!1;return new Promise(function(d,
f){a.socket.onOpen(function(){b=!0;a.socket.join("discovery",{},function(b){a.addDiscoveryChannel(b);d()})});a.socket.onError(function(){b||(a.socket.reconnect=function(){},a.socket=null,f(Error("Failed to connect to signalling server!")))})})};b.prototype.join=function(a){var b=this;null==this.socket&&d.err("Connect the signalling server first!");"room:"+a!=this.currentRoom&&(this.currentRoom&&this.socket.leave(this.currentRoom,{}),this.socket.join("room:"+a,{user_id:this.id},function(d){return b.addChannel(a,
d)}))};b.prototype.addDiscoveryChannel=function(a){this.discoveryChannel=a;a.on("get:room",this.receiveDiscovery)};b.prototype.discover=function(a,b){var d=(new Date).getTime();this.discoveryCallbacks[d]=b;this.discoveryChannel.send("get:room",{id:a,r:d})};b.prototype.signal=function(a,b){d.debug("Signalling to ",a,b);this.signalChannel.send("msg:user",{to:a,data:b})};return b}();d.Signaller=e})(excess||(excess={}));(function(){(function(d,e){return"function"===typeof define&&define.amd?define(["phoenix"],e):"object"===typeof exports?e(exports):e(d.Phoenix={})})(this,function(d){var e;e=this;d.Channel=function(){function b(a,b,d,f){this.topic=a;this.message=b;this.callback=d;this.socket=f;this.reset()}b.prototype.bindings=null;b.prototype.reset=function(){return this.bindings=[]};b.prototype.on=function(a,b){return this.bindings.push({event:a,callback:b})};b.prototype.isMember=function(a){return this.topic===
a};b.prototype.off=function(a){var b,d,f,g,e;g=this.bindings;e=[];d=0;for(f=g.length;d<f;d++)b=g[d],b.event!==a&&e.push(b);return this.bindings=e};b.prototype.trigger=function(a,b){var d,f,g,e,m,n;m=this.bindings;n=[];g=0;for(e=m.length;g<e;g++)d=m[g],f=d.event,d=d.callback,f===a&&n.push(d(b));return n};b.prototype.send=function(a,b){return this.socket.send({topic:this.topic,event:a,payload:b})};b.prototype.leave=function(a){null==a&&(a={});this.socket.leave(this.topic,a);return this.reset()};return b}();
d.Socket=function(){function b(a,b){var k,f,g,l;null==b&&(b={});this.states=d.Socket.states;this.transport=null!=(k=null!=(f=b.transport)?f:e.WebSocket)?k:d.LongPoller;this.heartbeatIntervalMs=null!=(g=b.heartbeatIntervalMs)?g:this.heartbeatIntervalMs;this.logger=null!=(l=b.logger)?l:function(){};this.endPoint=this.expandEndpoint(a);this.channels=[];this.sendBuffer=[];this.stateChangeCallbacks={open:[],close:[],error:[],message:[]};this.resetBufferTimer();this.reconnect()}b.states={connecting:0,open:1,
closing:2,closed:3};b.prototype.conn=null;b.prototype.endPoint=null;b.prototype.channels=null;b.prototype.sendBuffer=null;b.prototype.sendBufferTimer=null;b.prototype.flushEveryMs=50;b.prototype.reconnectTimer=null;b.prototype.reconnectAfterMs=5E3;b.prototype.heartbeatIntervalMs=3E4;b.prototype.stateChangeCallbacks=null;b.prototype.transport=null;b.prototype.protocol=function(){return location.protocol.match(/^https/)?"wss":"ws"};b.prototype.expandEndpoint=function(a){return"/"!==a.charAt(0)?a:"/"===
a.charAt(1)?""+this.protocol()+":"+a:""+this.protocol()+"://"+location.host+a};b.prototype.close=function(a,b,d){null!=this.conn&&(this.conn.onclose=function(a){return function(){}}(this),null!=b?this.conn.close(b,null!=d?d:""):this.conn.close(),this.conn=null);return"function"===typeof a?a():void 0};b.prototype.reconnect=function(){return this.close(function(a){return function(){a.conn=new a.transport(a.endPoint);a.conn.onopen=function(){return a.onConnOpen()};a.conn.onerror=function(b){return a.onConnError(b)};
a.conn.onmessage=function(b){return a.onConnMessage(b)};return a.conn.onclose=function(b){return a.onConnClose(b)}}}(this))};b.prototype.resetBufferTimer=function(){clearTimeout(this.sendBufferTimer);return this.sendBufferTimer=setTimeout(function(a){return function(){return a.flushSendBuffer()}}(this),this.flushEveryMs)};b.prototype.log=function(a){return this.logger(a)};b.prototype.onOpen=function(a){if(a)return this.stateChangeCallbacks.open.push(a)};b.prototype.onClose=function(a){if(a)return this.stateChangeCallbacks.close.push(a)};
b.prototype.onError=function(a){if(a)return this.stateChangeCallbacks.error.push(a)};b.prototype.onMessage=function(a){if(a)return this.stateChangeCallbacks.message.push(a)};b.prototype.onConnOpen=function(){var a,b,d,f,g;clearInterval(this.reconnectTimer);this.transport.skipHeartbeat||(this.heartbeatTimer=setInterval(function(a){return function(){return a.sendHeartbeat()}}(this),this.heartbeatIntervalMs));this.rejoinAll();f=this.stateChangeCallbacks.open;g=[];b=0;for(d=f.length;b<d;b++)a=f[b],g.push(a());
return g};b.prototype.onConnClose=function(a){var b,d,f,g,e;this.log("WS close:");this.log(a);clearInterval(this.reconnectTimer);clearInterval(this.heartbeatTimer);this.reconnectTimer=setInterval(function(a){return function(){return a.reconnect()}}(this),this.reconnectAfterMs);g=this.stateChangeCallbacks.close;e=[];d=0;for(f=g.length;d<f;d++)b=g[d],e.push(b(a));return e};b.prototype.onConnError=function(a){var b,d,f,e,l;this.log("WS error:");this.log(a);e=this.stateChangeCallbacks.error;l=[];d=0;
for(f=e.length;d<f;d++)b=e[d],l.push(b(a));return l};b.prototype.connectionState=function(){var a;switch(null!=(a=this.conn)?a.readyState:void 0){case this.states.connecting:return"connecting";case this.states.open:return"open";case this.states.closing:return"closing";case this.states.closed:case null:return"closed"}};b.prototype.isConnected=function(){return"open"===this.connectionState()};b.prototype.rejoinAll=function(){var a,b,d,f,e;f=this.channels;e=[];b=0;for(d=f.length;b<d;b++)a=f[b],e.push(this.rejoin(a));
return e};b.prototype.rejoin=function(a){a.reset();this.send({topic:a.topic,event:"join",payload:a.message});return a.callback(a)};b.prototype.join=function(a,b,e){a=new d.Channel(a,b,e,this);this.channels.push(a);if(this.isConnected())return this.rejoin(a)};b.prototype.leave=function(a,b){var d;null==b&&(b={});this.send({topic:a,event:"leave",payload:b});var e,g,l,m;l=this.channels;m=[];e=0;for(g=l.length;e<g;e++)d=l[e],d.isMember(a)||m.push(d);return this.channels=m};b.prototype.send=function(a){var b;
b=function(b){return function(){return b.conn.send(JSON.stringify(a))}}(this);return this.isConnected()?b():this.sendBuffer.push(b)};b.prototype.sendHeartbeat=function(){return this.send({topic:"phoenix",event:"heartbeat",payload:{}})};b.prototype.flushSendBuffer=function(){var a,b,d,e;if(this.isConnected()&&0<this.sendBuffer.length){e=this.sendBuffer;b=0;for(d=e.length;b<d;b++)a=e[b],a();this.sendBuffer=[]}return this.resetBufferTimer()};b.prototype.onConnMessage=function(a){var b,d,e,g,l,m,n;this.log("message received:");
this.log(a);d=JSON.parse(a.data);e=d.topic;a=d.event;d=d.payload;m=this.channels;g=0;for(l=m.length;g<l;g++)b=m[g],b.isMember(e)&&b.trigger(a,d);m=this.stateChangeCallbacks.message;n=[];g=0;for(l=m.length;g<l;g++)b=m[g],n.push(b(e,a,d));return n};return b}();d.LongPoller=function(){function b(a){this.states=d.Socket.states;this.upgradeEndpoint=this.normalizeEndpoint(a);this.pollEndpoint=this.upgradeEndpoint+(/\/$/.test(a)?"poll":"/poll");this.readyState=this.states.connecting;this.open()}b.prototype.retryInMs=
5E3;b.prototype.endPoint=null;b.prototype.skipHeartbeat=!0;b.prototype.onopen=function(){};b.prototype.onerror=function(){};b.prototype.onmessage=function(){};b.prototype.onclose=function(){};b.prototype.open=function(){return d.Ajax.request("POST",this.upgradeEndpoint,"application/json",null,function(a){return function(b,d){return 200===b?(a.readyState=a.states.open,a.onopen(),a.poll()):a.onerror()}}(this))};b.prototype.normalizeEndpoint=function(a){return a.replace("ws://","http://").replace("wss://",
"https://")};b.prototype.poll=function(){if(this.readyState===this.states.open)return d.Ajax.request("GET",this.pollEndpoint,"application/json",null,function(a){return function(b,d){var e,g,l,m;switch(b){case 200:m=JSON.parse(d);g=0;for(l=m.length;g<l;g++)e=m[g],a.onmessage({data:JSON.stringify(e)});return a.poll();case 204:return a.poll();default:return a.close(),setTimeout(function(){return a.open()},a.retryInMs)}}}(this))};b.prototype.send=function(a){return d.Ajax.request("POST",this.pollEndpoint,
"application/json",a,function(a){return function(b,d){if(200!==b)return a.onerror()}}(this))};b.prototype.close=function(a,b){this.readyState=this.states.closed;return this.onclose()};return b}();d.Ajax={states:{complete:4},request:function(b,a,d,k,f){var g;g=null!=e.XMLHttpRequest?new e.XMLHttpRequest:new e.ActiveXObject("Microsoft.XMLHTTP");g.open(b,a,!0);g.setRequestHeader("Content-type",d);g.onreadystatechange=function(a){return function(){if(g.readyState===a.states.complete)return"function"===
typeof f?f(g.status,g.responseText):void 0}}(this);return g.send(k)}};return d})}).call(this);
