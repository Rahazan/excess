var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;function trace(d){"\n"===d[d.length-1]&&(d=d.substring(0,d.length-1));if(window.performance){var e=(window.performance.now()/1E3).toFixed(3);console.log(e+": "+d)}else console.log(d)}
if(navigator.mozGetUserMedia)console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=function(d,e){if(d&&d.iceServers)for(var b=0;b<d.iceServers.length;b++)d.iceServers[b].hasOwnProperty("urls")&&(d.iceServers[b].url=d.iceServers[b].urls,delete d.iceServers[b].urls);return new mozRTCPeerConnection(d,e)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=
mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,MediaStreamTrack.getSources=function(d){setTimeout(function(){d([{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}])},0)},window.createIceServer=function(d,e,b){var a=null,f=d.split(":");if(0===f[0].indexOf("stun"))a={url:d};else if(0===f[0].indexOf("turn"))if(27>webrtcDetectedVersion){if(d=d.split("?"),1===d.length||0===d[1].indexOf("transport=udp"))a=
{url:d[0],credential:b,username:e}}else a={url:d,credential:b,username:e};return a},window.createIceServers=function(d,e,b){for(var a=[],f=0;f<d.length;f++){var m=window.createIceServer(d[f],e,b);null!==m&&a.push(m)}return a},attachMediaStream=function(d,e){console.log("Attaching media stream");d.mozSrcObject=e},reattachMediaStream=function(d,e){console.log("Reattaching media stream");d.mozSrcObject=e.mozSrcObject};else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome");var webrtcDetectedBrowser=
"chrome",result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./),webrtcDetectedVersion=null!==result?parseInt(result[2],10):999;window.createIceServer=function(d,e,b){var a=null,f=d.split(":");0===f[0].indexOf("stun")?a={url:d}:0===f[0].indexOf("turn")&&(a={url:d,credential:b,username:e});return a};window.createIceServers=function(d,e,b){return{urls:d,credential:b,username:e}};RTCPeerConnection=function(d,e){return new webkitRTCPeerConnection(d,e)};getUserMedia=navigator.webkitGetUserMedia.bind(navigator);
navigator.getUserMedia=getUserMedia;attachMediaStream=function(d,e){"undefined"!==typeof d.srcObject?d.srcObject=e:"undefined"!==typeof d.mozSrcObject?d.mozSrcObject=e:"undefined"!==typeof d.src?d.src=URL.createObjectURL(e):console.log("Error attaching stream to element.")};reattachMediaStream=function(d,e){d.src=e.src}}else console.log("Browser does not appear to be WebRTC-capable");
function requestUserMedia(d){return new Promise(function(e,b){var a=function(a){e(a)},f=function(a){b(a)};try{getUserMedia(d,a,f)}catch(m){b(m)}})};var events;
(function(d){var e=function(){function b(){this._listeners=[]}b.prototype.add=function(a){this._listeners.push(a)};b.prototype.remove=function(a){if("function"===typeof a)for(var f=this._listeners.length;0<f;f++){if(this._listeners[0]===a){this._listeners.splice(0,1);break}}else this._listeners=[]};b.prototype.trigger=function(){for(var a=[],f=0;f<arguments.length;f++)a[f-0]=arguments[f];for(var f={},m=this._listeners.slice(0),b=0,d=m.length;b<d;b++)m[b].apply(f,a||[])};return b}();d.TypedEvent=e})(events||
(events={}));var excess;(function(d){d.log=console.log;d.debug=console.debug;d.err=console.error})(excess||(excess={}));var c;window.onload=function(){};
(function(d){var e=function(){function b(a){var f=this;this.onMessage=new events.TypedEvent;this.onClose=new events.TypedEvent;this.onError=new events.TypedEvent;this.onOpen=new events.TypedEvent;this._onMessage=function(a){d.log("\nCHANNEL MESSAGE: ",a.data);f.onMessage.trigger(a.data)};this._onError=function(a){d.log("\nCHANNEL ERROR: ",a);f.onError.trigger(a)};this._onClose=function(a){d.log("\nCHANNEL CLOSE: ",a);f.onClose.trigger(a)};this._onOpen=function(a){d.log("\nCHANNEL OPEN: ",a);f.onOpen.trigger(a)};
this.dataChannel=a;this.attachCallbacks()}b.prototype.attachCallbacks=function(){this.dataChannel.onmessage=this._onMessage;this.dataChannel.onerror=this._onError;this.dataChannel.onclose=this._onClose;this.dataChannel.onopen=this._onOpen};b.prototype.send=function(a){this.dataChannel.send(a)};return b}();d.Channel=e})(excess||(excess={}));
(function(d){var e=function(){function b(a,f,b){var g=this;void 0===b&&(b=[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"}]);this.onConnection=new events.TypedEvent;this.receiveSignalMessage=function(a,f){var b=g.connections[a]?!0:!1;f?"offer"==f.type?(b&&console.warn("Already have a connection with fromId!"),d.log("Received OFFER from",a,f),g.createPeer(a).answer(f)):"answer"==f.type?b?(d.log("Received ANSWER from ",a,f),g.connections[a].setRemoteDescription(f)):console.error("Received answer SDP from unknown peer: ",
a):f.candidate?b?(d.debug("Received ICE candidate from",a,f),g.connections[a].addIceCandidate(f)):console.error("Received ICE candidate from unknown peer: ",a):console.warn("Received unexpected signal message ",f," from ",a):console.error("Received empty signalling message, error from server?")};this.id=f;this.connections={};this.rtcConfig={iceServers:b};this.signaller=new d.Signaller(a,f);this.signaller.onSignal.add(this.receiveSignalMessage)}b.prototype.connectToServer=function(){return this.signaller.connect()};
b.prototype.connect=function(a){if(a==this.id)return console.error("You can't connect to yourself!"),null;a=this.createPeer(a);a.call();return a};b.prototype.createPeer=function(a){var f=this;d.log("Creating peer for ",a);var b=new d.ExcessPeer(a,this.signaller,this.rtcConfig);this.connections[a]=b;b.onClose.add(function(){d.log("Connection to ",a,"closed, deleting peer");delete f.connections[a]});return b};b.prototype.joinRoom=function(a){this.currentRoom=a;this.signaller.join(a)};return b}();d.ExcessClient=
e})(excess||(excess={}));
(function(d){var e=function(){function b(a,f,b){var g=this;this.onClose=new events.TypedEvent;this.onDataChannelReceive=new events.TypedEvent;this.remoteDescriptionSet=this.caller=!1;this.onSDPCreate=function(a){g.connection.setLocalDescription(a,g.onLocalDescrAdded,function(){return d.err("Failed to set local description!")});g.signaller.signal(g.id,a)};this.onSDPError=function(a){console.error(a)};this.onLocalDescrAdded=function(){d.log("Set local description ",g.caller?"(OFFER).":"(ANSWER).")};
this.onStateChange=function(a){d.log("Connection state change ",a)};this.onIceStateChange=function(a){d.log("ICE state changed: connection:",g.connection.iceConnectionState,"gathering:",g.connection.iceGatheringState)};this.onIceCandidate=function(a){a.candidate&&g.signaller.signal(g.id,{sdpMLineIndex:a.candidate.sdpMLineIndex,sdpMid:a.candidate.sdpMid,candidate:a.candidate.candidate})};this.signaller=f;this.id=a;this.iceBuffer=[];this.channels={};this.connection=new RTCPeerConnection(b);this.connection.ondatachannel=
function(a){g.addDataChannel(a.channel);g.onDataChannelReceive.trigger(g.channels[a.channel.label])};this.connection.onnegotiationneeded=function(a){return console.warn("Negotation needed!")};this.connection.onicecandidate=this.onIceCandidate;this.connection.onstatechange=this.onStateChange;this.connection.oniceconnectionstatechange=this.onIceStateChange}b.prototype.call=function(){this.createDataChannel("excess");this.caller=!0;this.connection.createOffer(this.onSDPCreate,this.onSDPError)};b.prototype.answer=
function(a){var f=this;this.caller&&(this.caller=!1);this.setRemoteDescription(a,function(){return f.connection.createAnswer(f.onSDPCreate,f.onSDPError)})};b.prototype.createDataChannel=function(a,f){void 0===f&&(f={});d.log("Creating data channel ",a," opts:",f);var b=this.connection.createDataChannel(a,f);return this.addDataChannel(b)};b.prototype.addDataChannel=function(a){var f=this;"object"!=typeof a&&console.error("Data channel is not even an object!");d.log("Added data channel ",a);var b=new d.Channel(a);
this.channels[a.label]=b;this.channels[a.label].onClose.add(function(){return delete f.channels[a.label]});return b};b.prototype.addIceCandidate=function(a){this.remoteDescriptionSet?(a=new RTCIceCandidate(a),this.connection.addIceCandidate(a)):(d.log("Buffering ICE candidate"),this.iceBuffer.push(a))};b.prototype.setRemoteDescription=function(a,f){var b=this;void 0===f&&(f=function(){});d.log("Attempting to set remote description.");var g=new RTCSessionDescription(a);this.connection.setRemoteDescription(g,
function(){d.log("Set remote description",b.caller?"(ANSWER).":"(OFFER).");b.remoteDescriptionSet=!0;b.addIceBuffer();f.apply(b)},function(a){return console.error("Failed to set remote descr",a)})};b.prototype.addIceBuffer=function(){for(;0<this.iceBuffer.length;){var a=this.iceBuffer.shift();this.addIceCandidate(a)}};return b}();d.ExcessPeer=e})(excess||(excess={}));
(function(d){var e=function(){function b(a,f){var b=this;this.onSignal=new events.TypedEvent;this.addChannel=function(a,f){b.signalChannel=f;b.currentRoom=f.topic;f.on("msg:user",function(a){b.onSignal.trigger(a.from,a.data)})};this.receiveDiscovery=function(a){b.discoveryCallbacks[a.r](a.users);delete b.discoveryCallbacks[a.r]};this.id=f;this.discoveryCallbacks={};this.endPoint=a}b.prototype.connect=function(){var a=this;this.socket=new Phoenix.Socket(this.endPoint);var f=!1;return new Promise(function(b,
d){a.socket.onOpen(function(){f=!0;a.socket.join("discovery",{},function(f){return a.addDiscoveryChannel(f)});b()});a.socket.onError(function(){f||(a.socket.reconnect=function(){},a.socket=null,d(Error("Failed to connect to signalling server!")))})})};b.prototype.join=function(a){var f=this;null==this.socket&&d.err("Connect the signalling server first!");"room:"+a!=this.currentRoom&&(this.currentRoom&&this.socket.leave(this.currentRoom,{}),this.socket.join("room:"+a,{user_id:this.id},function(b){return f.addChannel(a,
b)}))};b.prototype.addDiscoveryChannel=function(a){this.discoveryChannel=a;a.on("get:room",this.receiveDiscovery)};b.prototype.discover=function(a,f){var b=(new Date).getTime();this.discoveryCallbacks[b]=f;this.discoveryChannel.send("get:room",{id:a,r:b})};b.prototype.signal=function(a,b){d.debug("Signalling to ",a,b);this.signalChannel.send("msg:user",{to:a,data:b})};return b}();d.Signaller=e})(excess||(excess={}));(function(){(function(d,e){return"function"===typeof define&&define.amd?define(["phoenix"],e):"object"===typeof exports?e(exports):e(d.Phoenix={})})(this,function(d){var e;e=this;d.Channel=function(){function b(a,b,d,g){this.topic=a;this.message=b;this.callback=d;this.socket=g;this.reset()}b.prototype.bindings=null;b.prototype.reset=function(){return this.bindings=[]};b.prototype.on=function(a,b){return this.bindings.push({event:a,callback:b})};b.prototype.isMember=function(a){return this.topic===
a};b.prototype.off=function(a){var b,d,g,h,e;h=this.bindings;e=[];d=0;for(g=h.length;d<g;d++)b=h[d],b.event!==a&&e.push(b);return this.bindings=e};b.prototype.trigger=function(a,b){var d,g,h,e,l,n;l=this.bindings;n=[];h=0;for(e=l.length;h<e;h++)d=l[h],g=d.event,d=d.callback,g===a&&n.push(d(b));return n};b.prototype.send=function(a,b){return this.socket.send({topic:this.topic,event:a,payload:b})};b.prototype.leave=function(a){null==a&&(a={});this.socket.leave(this.topic,a);return this.reset()};return b}();
d.Socket=function(){function b(a,b){var m,g,h,k;null==b&&(b={});this.states=d.Socket.states;this.transport=null!=(m=null!=(g=b.transport)?g:e.WebSocket)?m:d.LongPoller;this.heartbeatIntervalMs=null!=(h=b.heartbeatIntervalMs)?h:this.heartbeatIntervalMs;this.logger=null!=(k=b.logger)?k:function(){};this.endPoint=this.expandEndpoint(a);this.channels=[];this.sendBuffer=[];this.stateChangeCallbacks={open:[],close:[],error:[],message:[]};this.resetBufferTimer();this.reconnect()}b.states={connecting:0,open:1,
closing:2,closed:3};b.prototype.conn=null;b.prototype.endPoint=null;b.prototype.channels=null;b.prototype.sendBuffer=null;b.prototype.sendBufferTimer=null;b.prototype.flushEveryMs=50;b.prototype.reconnectTimer=null;b.prototype.reconnectAfterMs=5E3;b.prototype.heartbeatIntervalMs=3E4;b.prototype.stateChangeCallbacks=null;b.prototype.transport=null;b.prototype.protocol=function(){return location.protocol.match(/^https/)?"wss":"ws"};b.prototype.expandEndpoint=function(a){return"/"!==a.charAt(0)?a:"/"===
a.charAt(1)?""+this.protocol()+":"+a:""+this.protocol()+"://"+location.host+a};b.prototype.close=function(a,b,d){null!=this.conn&&(this.conn.onclose=function(a){return function(){}}(this),null!=b?this.conn.close(b,null!=d?d:""):this.conn.close(),this.conn=null);return"function"===typeof a?a():void 0};b.prototype.reconnect=function(){return this.close(function(a){return function(){a.conn=new a.transport(a.endPoint);a.conn.onopen=function(){return a.onConnOpen()};a.conn.onerror=function(b){return a.onConnError(b)};
a.conn.onmessage=function(b){return a.onConnMessage(b)};return a.conn.onclose=function(b){return a.onConnClose(b)}}}(this))};b.prototype.resetBufferTimer=function(){clearTimeout(this.sendBufferTimer);return this.sendBufferTimer=setTimeout(function(a){return function(){return a.flushSendBuffer()}}(this),this.flushEveryMs)};b.prototype.log=function(a){return this.logger(a)};b.prototype.onOpen=function(a){if(a)return this.stateChangeCallbacks.open.push(a)};b.prototype.onClose=function(a){if(a)return this.stateChangeCallbacks.close.push(a)};
b.prototype.onError=function(a){if(a)return this.stateChangeCallbacks.error.push(a)};b.prototype.onMessage=function(a){if(a)return this.stateChangeCallbacks.message.push(a)};b.prototype.onConnOpen=function(){var a,b,d,g,e;clearInterval(this.reconnectTimer);this.transport.skipHeartbeat||(this.heartbeatTimer=setInterval(function(a){return function(){return a.sendHeartbeat()}}(this),this.heartbeatIntervalMs));this.rejoinAll();g=this.stateChangeCallbacks.open;e=[];b=0;for(d=g.length;b<d;b++)a=g[b],e.push(a());
return e};b.prototype.onConnClose=function(a){var b,d,g,e,k;this.log("WS close:");this.log(a);clearInterval(this.reconnectTimer);clearInterval(this.heartbeatTimer);this.reconnectTimer=setInterval(function(a){return function(){return a.reconnect()}}(this),this.reconnectAfterMs);e=this.stateChangeCallbacks.close;k=[];d=0;for(g=e.length;d<g;d++)b=e[d],k.push(b(a));return k};b.prototype.onConnError=function(a){var b,d,g,e,k;this.log("WS error:");this.log(a);e=this.stateChangeCallbacks.error;k=[];d=0;
for(g=e.length;d<g;d++)b=e[d],k.push(b(a));return k};b.prototype.connectionState=function(){var a;switch(null!=(a=this.conn)?a.readyState:void 0){case this.states.connecting:return"connecting";case this.states.open:return"open";case this.states.closing:return"closing";case this.states.closed:case null:return"closed"}};b.prototype.isConnected=function(){return"open"===this.connectionState()};b.prototype.rejoinAll=function(){var a,b,d,e,h;e=this.channels;h=[];b=0;for(d=e.length;b<d;b++)a=e[b],h.push(this.rejoin(a));
return h};b.prototype.rejoin=function(a){a.reset();this.send({topic:a.topic,event:"join",payload:a.message});return a.callback(a)};b.prototype.join=function(a,b,e){a=new d.Channel(a,b,e,this);this.channels.push(a);if(this.isConnected())return this.rejoin(a)};b.prototype.leave=function(a,b){var d;null==b&&(b={});this.send({topic:a,event:"leave",payload:b});var e,h,k,l;k=this.channels;l=[];e=0;for(h=k.length;e<h;e++)d=k[e],d.isMember(a)||l.push(d);return this.channels=l};b.prototype.send=function(a){var b;
b=function(b){return function(){return b.conn.send(JSON.stringify(a))}}(this);return this.isConnected()?b():this.sendBuffer.push(b)};b.prototype.sendHeartbeat=function(){return this.send({topic:"phoenix",event:"heartbeat",payload:{}})};b.prototype.flushSendBuffer=function(){var a,b,d,e;if(this.isConnected()&&0<this.sendBuffer.length){e=this.sendBuffer;b=0;for(d=e.length;b<d;b++)a=e[b],a();this.sendBuffer=[]}return this.resetBufferTimer()};b.prototype.onConnMessage=function(a){var b,d,e,h,k,l,n;this.log("message received:");
this.log(a);d=JSON.parse(a.data);e=d.topic;a=d.event;d=d.payload;l=this.channels;h=0;for(k=l.length;h<k;h++)b=l[h],b.isMember(e)&&b.trigger(a,d);l=this.stateChangeCallbacks.message;n=[];h=0;for(k=l.length;h<k;h++)b=l[h],n.push(b(e,a,d));return n};return b}();d.LongPoller=function(){function b(a){this.states=d.Socket.states;this.upgradeEndpoint=this.normalizeEndpoint(a);this.pollEndpoint=this.upgradeEndpoint+(/\/$/.test(a)?"poll":"/poll");this.readyState=this.states.connecting;this.open()}b.prototype.retryInMs=
5E3;b.prototype.endPoint=null;b.prototype.skipHeartbeat=!0;b.prototype.onopen=function(){};b.prototype.onerror=function(){};b.prototype.onmessage=function(){};b.prototype.onclose=function(){};b.prototype.open=function(){return d.Ajax.request("POST",this.upgradeEndpoint,"application/json",null,function(a){return function(b,d){return 200===b?(a.readyState=a.states.open,a.onopen(),a.poll()):a.onerror()}}(this))};b.prototype.normalizeEndpoint=function(a){return a.replace("ws://","http://").replace("wss://",
"https://")};b.prototype.poll=function(){if(this.readyState===this.states.open)return d.Ajax.request("GET",this.pollEndpoint,"application/json",null,function(a){return function(b,d){var e,h,k,l;switch(b){case 200:l=JSON.parse(d);h=0;for(k=l.length;h<k;h++)e=l[h],a.onmessage({data:JSON.stringify(e)});return a.poll();case 204:return a.poll();default:return a.close(),setTimeout(function(){return a.open()},a.retryInMs)}}}(this))};b.prototype.send=function(a){return d.Ajax.request("POST",this.pollEndpoint,
"application/json",a,function(a){return function(b,d){if(200!==b)return a.onerror()}}(this))};b.prototype.close=function(a,b){this.readyState=this.states.closed;return this.onclose()};return b}();d.Ajax={states:{complete:4},request:function(b,a,d,m,g){var h;h=null!=e.XMLHttpRequest?new e.XMLHttpRequest:new e.ActiveXObject("Microsoft.XMLHTTP");h.open(b,a,!0);h.setRequestHeader("Content-type",d);h.onreadystatechange=function(a){return function(){if(h.readyState===a.states.complete)return"function"===
typeof g?g(h.status,h.responseText):void 0}}(this);return h.send(m)}};return d})}).call(this);
