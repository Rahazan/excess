var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;function trace(c){"\n"===c[c.length-1]&&(c=c.substring(0,c.length-1));if(window.performance){var d=(window.performance.now()/1E3).toFixed(3);console.log(d+": "+c)}else console.log(c)}
if(navigator.mozGetUserMedia)console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=function(c,d){if(c&&c.iceServers)for(var b=0;b<c.iceServers.length;b++)c.iceServers[b].hasOwnProperty("urls")&&(c.iceServers[b].url=c.iceServers[b].urls,delete c.iceServers[b].urls);return new mozRTCPeerConnection(c,d)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=
mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,MediaStreamTrack.getSources=function(c){setTimeout(function(){c([{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}])},0)},window.createIceServer=function(c,d,b){var a=null,e=c.split(":");if(0===e[0].indexOf("stun"))a={url:c};else if(0===e[0].indexOf("turn"))if(27>webrtcDetectedVersion){if(c=c.split("?"),1===c.length||0===c[1].indexOf("transport=udp"))a=
{url:c[0],credential:b,username:d}}else a={url:c,credential:b,username:d};return a},window.createIceServers=function(c,d,b){for(var a=[],e=0;e<c.length;e++){var l=window.createIceServer(c[e],d,b);null!==l&&a.push(l)}return a},attachMediaStream=function(c,d){console.log("Attaching media stream");c.mozSrcObject=d},reattachMediaStream=function(c,d){console.log("Reattaching media stream");c.mozSrcObject=d.mozSrcObject};else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome");var webrtcDetectedBrowser=
"chrome",result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./),webrtcDetectedVersion=null!==result?parseInt(result[2],10):999;window.createIceServer=function(c,d,b){var a=null,e=c.split(":");0===e[0].indexOf("stun")?a={url:c}:0===e[0].indexOf("turn")&&(a={url:c,credential:b,username:d});return a};window.createIceServers=function(c,d,b){return{urls:c,credential:b,username:d}};RTCPeerConnection=function(c,d){return new webkitRTCPeerConnection(c,d)};getUserMedia=navigator.webkitGetUserMedia.bind(navigator);
navigator.getUserMedia=getUserMedia;attachMediaStream=function(c,d){"undefined"!==typeof c.srcObject?c.srcObject=d:"undefined"!==typeof c.mozSrcObject?c.mozSrcObject=d:"undefined"!==typeof c.src?c.src=URL.createObjectURL(d):console.log("Error attaching stream to element.")};reattachMediaStream=function(c,d){c.src=d.src}}else console.log("Browser does not appear to be WebRTC-capable");
function requestUserMedia(c){return new Promise(function(d,b){var a=function(a){d(a)},e=function(a){b(a)};try{getUserMedia(c,a,e)}catch(l){b(l)}})};var events;
(function(c){var d=function(){function b(){this._listeners=[]}b.prototype.add=function(a){this._listeners.push(a)};b.prototype.remove=function(a){if("function"===typeof a)for(var e=this._listeners.length;0<e;e++){if(this._listeners[0]===a){this._listeners.splice(0,1);break}}else this._listeners=[]};b.prototype.trigger=function(){for(var a=[],e=0;e<arguments.length;e++)a[e-0]=arguments[e];for(var e={},l=this._listeners.slice(0),b=0,c=l.length;b<c;b++)l[b].apply(e,a||[])};return b}();c.TypedEvent=d})(events||
(events={}));var excess;(function(c){c.log=console.log;c.debug=console.debug;c.err=console.error})(excess||(excess={}));
(function(c){var d=function(){function b(a){var e=this;this.onMessage=new events.TypedEvent;this.onClose=new events.TypedEvent;this.onError=new events.TypedEvent;this.onOpen=new events.TypedEvent;this._onMessage=function(a){c.log("\nCHANNEL MESSAGE: ",a.data);e.onMessage.trigger(a.data)};this._onError=function(a){c.log("\nCHANNEL ERROR: ",a);e.onError.trigger(a)};this._onClose=function(a){c.log("\nCHANNEL CLOSE: ",a);e.onClose.trigger(a)};this._onOpen=function(a){c.log("\nCHANNEL OPEN: ",a);e.onOpen.trigger(a)};
this.dataChannel=a;this.attachCallbacks()}b.prototype.attachCallbacks=function(){this.dataChannel.onmessage=this._onMessage;this.dataChannel.onerror=this._onError;this.dataChannel.onclose=this._onClose;this.dataChannel.onopen=this._onOpen};b.prototype.send=function(a){this.dataChannel.send(a)};return b}();c.Channel=d})(excess||(excess={}));
(function(c){var d=function(){function b(a,e,b){var f=this;void 0===b&&(b=[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"}]);this.onConnection=new events.TypedEvent;this.receiveSignalMessage=function(a,e){var b=f.connections[a]?!0:!1;e?"offer"==e.type?(b&&console.warn("Already have a connection with fromId!"),c.log("Received OFFER from",a,e),f.createPeer(a).answer(e)):"answer"==e.type?b?(c.log("Received ANSWER from ",a,e),f.connections[a].setRemoteDescription(e)):console.error("Received answer SDP from unknown peer: ",
a):e.candidate?b?(c.debug("Received ICE candidate from",a,e),f.connections[a].addIceCandidate(e)):console.error("Received ICE candidate from unknown peer: ",a):console.warn("Received unexpected signal message ",e," from ",a):console.error("Received empty signalling message, error from server?")};this.id=e;this.connections={};this.rtcConfig={iceServers:b};this.signaller=new c.Signaller(a,e);this.signaller.onSignal.add(this.receiveSignalMessage)}b.prototype.connect=function(a){if(a==this.id)return console.error("You can't connect to yourself!"),
null;a=this.createPeer(a);a.call();return a};b.prototype.createPeer=function(a){var e=this;c.log("Creating peer for ",a);var b=new c.ExcessPeer(a,this.signaller,this.rtcConfig);this.connections[a]=b;b.onClose.add(function(){c.log("Connection to ",a,"closed, deleting peer");delete e.connections[a]});return b};b.prototype.joinRoom=function(a){this.currentRoom=a;this.signaller.join(a)};return b}();c.ExcessClient=d})(excess||(excess={}));
(function(c){var d=function(){function b(a,e,b){var f=this;this.onClose=new events.TypedEvent;this.onDataChannelReceive=new events.TypedEvent;this.remoteDescriptionSet=this.caller=!1;this.onSDPCreate=function(a){f.connection.setLocalDescription(a,f.onLocalDescrAdded,function(){return c.err("Failed to set local description!")});f.signaller.signal(f.id,a)};this.onSDPError=function(a){console.error(a)};this.onLocalDescrAdded=function(){c.log("Set local description ",f.caller?"(OFFER).":"(ANSWER).")};
this.onStateChange=function(a){c.log("Connection state change ",a)};this.onIceStateChange=function(a){c.log("ICE state changed: connection:",f.connection.iceConnectionState,"gathering:",f.connection.iceGatheringState)};this.onIceCandidate=function(a){a.candidate&&f.signaller.signal(f.id,{sdpMLineIndex:a.candidate.sdpMLineIndex,sdpMid:a.candidate.sdpMid,candidate:a.candidate.candidate})};this.signaller=e;this.id=a;this.iceBuffer=[];this.channels={};this.connection=new RTCPeerConnection(b);this.connection.ondatachannel=
function(a){f.addDataChannel(a.channel);f.onDataChannelReceive.trigger(f.channels[a.channel.label])};this.connection.onnegotiationneeded=function(a){return console.warn("Negotation needed!")};this.connection.onicecandidate=this.onIceCandidate;this.connection.onstatechange=this.onStateChange;this.connection.oniceconnectionstatechange=this.onIceStateChange}b.prototype.call=function(){this.createDataChannel("excess");this.caller=!0;this.connection.createOffer(this.onSDPCreate,this.onSDPError)};b.prototype.answer=
function(a){var e=this;this.caller&&(this.caller=!1);this.setRemoteDescription(a,function(){return e.connection.createAnswer(e.onSDPCreate,e.onSDPError)})};b.prototype.createDataChannel=function(a,e){void 0===e&&(e={});c.log("Creating data channel ",a," opts:",e);var b=this.connection.createDataChannel(a,e);return this.addDataChannel(b)};b.prototype.addDataChannel=function(a){var e=this;"object"!=typeof a&&console.error("Data channel is not even an object!");c.log("Added data channel ",a);var b=new c.Channel(a);
this.channels[a.label]=b;this.channels[a.label].onClose.add(function(){return delete e.channels[a.label]});return b};b.prototype.addIceCandidate=function(a){this.remoteDescriptionSet?(a=new RTCIceCandidate(a),this.connection.addIceCandidate(a)):(c.log("Buffering ICE candidate"),this.iceBuffer.push(a))};b.prototype.setRemoteDescription=function(a,e){var b=this;void 0===e&&(e=function(){});c.log("Attempting to set remote description.");var f=new RTCSessionDescription(a);this.connection.setRemoteDescription(f,
function(){c.log("Set remote description",b.caller?"(ANSWER).":"(OFFER).");b.remoteDescriptionSet=!0;b.addIceBuffer();e.apply(b)},function(a){return console.error("Failed to set remote descr",a)})};b.prototype.addIceBuffer=function(){for(;0<this.iceBuffer.length;){var a=this.iceBuffer.shift();this.addIceCandidate(a)}};return b}();c.ExcessPeer=d})(excess||(excess={}));
(function(c){var d=function(){function b(a,e){var b=this;this.onSignal=new events.TypedEvent;this.addChannel=function(a,e){b.signalChannel=e;b.currentRoom=e.topic;e.on("msg:user",function(a){b.onSignal.trigger(a.from,a.data)})};this.receiveDiscovery=function(a){b.discoveryCallbacks[a.r](a.users);delete b.discoveryCallbacks[a.r]};this.id=e;this.discoveryCallbacks={};this.socket=new Phoenix.Socket(a);this.socket.join("discovery",{},function(a){return b.addDiscoveryChannel(a)})}b.prototype.join=function(a){var e=
this;"room:"+a!=this.currentRoom&&(this.currentRoom&&this.socket.leave(this.currentRoom,{}),this.socket.join("room:"+a,{user_id:this.id},function(b){return e.addChannel(a,b)}))};b.prototype.addDiscoveryChannel=function(a){this.discoveryChannel=a;a.on("get:room",this.receiveDiscovery)};b.prototype.discover=function(a,b){var c=(new Date).getTime();this.discoveryCallbacks[c]=b;this.discoveryChannel.send("get:room",{id:a,r:c})};b.prototype.signal=function(a,b){c.debug("Signalling to ",a,b);this.signalChannel.send("msg:user",
{to:a,data:b})};return b}();c.Signaller=d})(excess||(excess={}));(function(){(function(c,d){return"function"===typeof define&&define.amd?define(["phoenix"],d):"object"===typeof exports?d(exports):d(c.Phoenix={})})(this,function(c){var d;d=this;c.Channel=function(){function b(a,b,c,f){this.topic=a;this.message=b;this.callback=c;this.socket=f;this.reset()}b.prototype.bindings=null;b.prototype.reset=function(){return this.bindings=[]};b.prototype.on=function(a,b){return this.bindings.push({event:a,callback:b})};b.prototype.isMember=function(a){return this.topic===
a};b.prototype.off=function(a){var b,c,f,g,d;g=this.bindings;d=[];c=0;for(f=g.length;c<f;c++)b=g[c],b.event!==a&&d.push(b);return this.bindings=d};b.prototype.trigger=function(a,b){var c,f,g,d,k,m;k=this.bindings;m=[];g=0;for(d=k.length;g<d;g++)c=k[g],f=c.event,c=c.callback,f===a&&m.push(c(b));return m};b.prototype.send=function(a,b){return this.socket.send({topic:this.topic,event:a,payload:b})};b.prototype.leave=function(a){null==a&&(a={});this.socket.leave(this.topic,a);return this.reset()};return b}();
c.Socket=function(){function b(a,b){var l,f,g,h;null==b&&(b={});this.states=c.Socket.states;this.transport=null!=(l=null!=(f=b.transport)?f:d.WebSocket)?l:c.LongPoller;this.heartbeatIntervalMs=null!=(g=b.heartbeatIntervalMs)?g:this.heartbeatIntervalMs;this.logger=null!=(h=b.logger)?h:function(){};this.endPoint=this.expandEndpoint(a);this.channels=[];this.sendBuffer=[];this.stateChangeCallbacks={open:[],close:[],error:[],message:[]};this.resetBufferTimer();this.reconnect()}b.states={connecting:0,open:1,
closing:2,closed:3};b.prototype.conn=null;b.prototype.endPoint=null;b.prototype.channels=null;b.prototype.sendBuffer=null;b.prototype.sendBufferTimer=null;b.prototype.flushEveryMs=50;b.prototype.reconnectTimer=null;b.prototype.reconnectAfterMs=5E3;b.prototype.heartbeatIntervalMs=3E4;b.prototype.stateChangeCallbacks=null;b.prototype.transport=null;b.prototype.protocol=function(){return location.protocol.match(/^https/)?"wss":"ws"};b.prototype.expandEndpoint=function(a){return"/"!==a.charAt(0)?a:"/"===
a.charAt(1)?""+this.protocol()+":"+a:""+this.protocol()+"://"+location.host+a};b.prototype.close=function(a,b,c){null!=this.conn&&(this.conn.onclose=function(a){return function(){}}(this),null!=b?this.conn.close(b,null!=c?c:""):this.conn.close(),this.conn=null);return"function"===typeof a?a():void 0};b.prototype.reconnect=function(){return this.close(function(a){return function(){a.conn=new a.transport(a.endPoint);a.conn.onopen=function(){return a.onConnOpen()};a.conn.onerror=function(b){return a.onConnError(b)};
a.conn.onmessage=function(b){return a.onConnMessage(b)};return a.conn.onclose=function(b){return a.onConnClose(b)}}}(this))};b.prototype.resetBufferTimer=function(){clearTimeout(this.sendBufferTimer);return this.sendBufferTimer=setTimeout(function(a){return function(){return a.flushSendBuffer()}}(this),this.flushEveryMs)};b.prototype.log=function(a){return this.logger(a)};b.prototype.onOpen=function(a){if(a)return this.stateChangeCallbacks.open.push(a)};b.prototype.onClose=function(a){if(a)return this.stateChangeCallbacks.close.push(a)};
b.prototype.onError=function(a){if(a)return this.stateChangeCallbacks.error.push(a)};b.prototype.onMessage=function(a){if(a)return this.stateChangeCallbacks.message.push(a)};b.prototype.onConnOpen=function(){var a,b,c,f,d;clearInterval(this.reconnectTimer);this.transport.skipHeartbeat||(this.heartbeatTimer=setInterval(function(a){return function(){return a.sendHeartbeat()}}(this),this.heartbeatIntervalMs));this.rejoinAll();f=this.stateChangeCallbacks.open;d=[];b=0;for(c=f.length;b<c;b++)a=f[b],d.push(a());
return d};b.prototype.onConnClose=function(a){var b,c,f,d,h;this.log("WS close:");this.log(a);clearInterval(this.reconnectTimer);clearInterval(this.heartbeatTimer);this.reconnectTimer=setInterval(function(a){return function(){return a.reconnect()}}(this),this.reconnectAfterMs);d=this.stateChangeCallbacks.close;h=[];c=0;for(f=d.length;c<f;c++)b=d[c],h.push(b(a));return h};b.prototype.onConnError=function(a){var b,c,f,d,h;this.log("WS error:");this.log(a);d=this.stateChangeCallbacks.error;h=[];c=0;
for(f=d.length;c<f;c++)b=d[c],h.push(b(a));return h};b.prototype.connectionState=function(){var a;switch(null!=(a=this.conn)?a.readyState:void 0){case this.states.connecting:return"connecting";case this.states.open:return"open";case this.states.closing:return"closing";case this.states.closed:case null:return"closed"}};b.prototype.isConnected=function(){return"open"===this.connectionState()};b.prototype.rejoinAll=function(){var a,b,c,d,g;d=this.channels;g=[];b=0;for(c=d.length;b<c;b++)a=d[b],g.push(this.rejoin(a));
return g};b.prototype.rejoin=function(a){a.reset();this.send({topic:a.topic,event:"join",payload:a.message});return a.callback(a)};b.prototype.join=function(a,b,d){a=new c.Channel(a,b,d,this);this.channels.push(a);if(this.isConnected())return this.rejoin(a)};b.prototype.leave=function(a,b){var c;null==b&&(b={});this.send({topic:a,event:"leave",payload:b});var d,g,h,k;h=this.channels;k=[];d=0;for(g=h.length;d<g;d++)c=h[d],c.isMember(a)||k.push(c);return this.channels=k};b.prototype.send=function(a){var b;
b=function(b){return function(){return b.conn.send(JSON.stringify(a))}}(this);return this.isConnected()?b():this.sendBuffer.push(b)};b.prototype.sendHeartbeat=function(){return this.send({topic:"phoenix",event:"heartbeat",payload:{}})};b.prototype.flushSendBuffer=function(){var a,b,c,d;if(this.isConnected()&&0<this.sendBuffer.length){d=this.sendBuffer;b=0;for(c=d.length;b<c;b++)a=d[b],a();this.sendBuffer=[]}return this.resetBufferTimer()};b.prototype.onConnMessage=function(a){var b,c,d,g,h,k,m;this.log("message received:");
this.log(a);c=JSON.parse(a.data);d=c.topic;a=c.event;c=c.payload;k=this.channels;g=0;for(h=k.length;g<h;g++)b=k[g],b.isMember(d)&&b.trigger(a,c);k=this.stateChangeCallbacks.message;m=[];g=0;for(h=k.length;g<h;g++)b=k[g],m.push(b(d,a,c));return m};return b}();c.LongPoller=function(){function b(a){this.states=c.Socket.states;this.upgradeEndpoint=this.normalizeEndpoint(a);this.pollEndpoint=this.upgradeEndpoint+(/\/$/.test(a)?"poll":"/poll");this.readyState=this.states.connecting;this.open()}b.prototype.retryInMs=
5E3;b.prototype.endPoint=null;b.prototype.skipHeartbeat=!0;b.prototype.onopen=function(){};b.prototype.onerror=function(){};b.prototype.onmessage=function(){};b.prototype.onclose=function(){};b.prototype.open=function(){return c.Ajax.request("POST",this.upgradeEndpoint,"application/json",null,function(a){return function(b,c){return 200===b?(a.readyState=a.states.open,a.onopen(),a.poll()):a.onerror()}}(this))};b.prototype.normalizeEndpoint=function(a){return a.replace("ws://","http://").replace("wss://",
"https://")};b.prototype.poll=function(){if(this.readyState===this.states.open)return c.Ajax.request("GET",this.pollEndpoint,"application/json",null,function(a){return function(b,c){var d,g,h,k;switch(b){case 200:k=JSON.parse(c);g=0;for(h=k.length;g<h;g++)d=k[g],a.onmessage({data:JSON.stringify(d)});return a.poll();case 204:return a.poll();default:return a.close(),setTimeout(function(){return a.open()},a.retryInMs)}}}(this))};b.prototype.send=function(a){return c.Ajax.request("POST",this.pollEndpoint,
"application/json",a,function(a){return function(b,c){if(200!==b)return a.onerror()}}(this))};b.prototype.close=function(a,b){this.readyState=this.states.closed;return this.onclose()};return b}();c.Ajax={states:{complete:4},request:function(b,a,c,l,f){var g;g=null!=d.XMLHttpRequest?new d.XMLHttpRequest:new d.ActiveXObject("Microsoft.XMLHTTP");g.open(b,a,!0);g.setRequestHeader("Content-type",c);g.onreadystatechange=function(a){return function(){if(g.readyState===a.states.complete)return"function"===
typeof f?f(g.status,g.responseText):void 0}}(this);return g.send(l)}};return c})}).call(this);
